/*
 Copyright 2011 http://colorhook.com.
 @author: <a href="colorhook@gmail.com">colorhook</a>
 @version:1.0.0
*/
(function(a){var b={VERSION:"1.0.0"},c=0,d=Object.prototype.toString,e=function(a,b,c,d,k){if(!b||!a)return a;if(k)switch(k){case 1:return e(a.prototype,b.prototype,c,d,0);case 2:e(a.prototype,b.prototype,c,d,0);break;case 3:return e(a,b.prototype,c,d,0);case 4:return e(a.prototype,b,c,d,0)}if(!b||!a)return a;c===void 0&&(c=!0);var j,l;if(d&&(l=d.length))for(k=0;k<l;k++){if(j=d[k],j in b&&(c||!(j in a)))a[j]=b[j]}else for(j in b)if(c||!(j in a))a[j]=b[j];return a};e(b,{mix:e,guid:function(a){var b=
c++ +"";return a?a+b:b},isUndefined:function(a){return a===void 0},isBoolean:function(a){return d.call(a)==="[object Boolean]"},isString:function(a){return d.call(a)==="[object String]"},isNumber:function(a){return d.call(a)==="[object Number]"&&isFinite(a)},isFunction:function(a){return d.call(a)==="[object Function]"},isArray:function(a){return d.call(a)==="[object Array]"},merge:function(){var a=arguments,b={},c,d=a.length;for(c=0;c<d;c+=1)e(b,a[c],!0);return b},namespace:function(){var a=arguments,
b=null,c,d,e,j;for(c=0;c<a.length;c+=1){e=(""+a[c]).split(".");b=this;j=e.length;for(d=e[0]=="JPE"?1:0;d<j;d+=1)b[e[d]]=b[e[d]]||{},b=b[e[d]]}return b},extend:function(a,b,c,d){if(!b||!a)return a;var k=Object.prototype,j=b.prototype,l=function(a){function b(){}b.prototype=a;return new b}(j);a.prototype=l;l.constructor=a;a.superclass=j;if(b!=Object&&j.constructor==k.constructor)j.constructor=b;c&&e(l,c,!0);d&&e(a,d,!0);a.superclass=b;return a},declare:function(a,b){if(this.isFunction(b)){var c=b();
this.isUndefined(c)||this.declare(a,c)}else{b=b||{};var d=b.superclass,e,j,l;c=b.hasOwnProperty("constructor")&&this.isFunction(b.constructor)?b.constructor:d?{}:function(){};delete b.constructor;d?c=this.extend(c,d,b):this.mix(c.prototype,b);d=(""+a).split(".");j=d[0]=="JPE"?1:0;e=d.length;for(l=this;j<e;j++)l[d[j]]=j==e-1?c:l[d[j]]||{},l=l[d[j]];return l}}});a.JPE=b})(window);
JPE.declare("Engine",function(){JPE.Engine={force:null,masslessForce:null,groups:null,numGroups:0,timeStep:0,damping:1,container:null,constaintCycles:0,constraintCollisionCycles:1,initSelf:function(a,b){isNaN(b)&&(b=0.25);this.timeStep=b*b;this.groups=[];this.force=new JPE.Vector(0,0);this.masslessForce=new JPE.Vector(0,0);this.container=new JPE.Sprite(a)},addForce:function(a){this.force.plusEquals(a)},addMasslessForce:function(a){this.masslessForce.plusEquals(a)},addGroup:function(a){this.groups.push(a);
a.isParented=!0;this.numGroups++;a.initSelf()},removeGroup:function(a){var b=Y.Array.indexOf(this.groups,a);if(b!=-1)this.groups.splice(b,1),a.isParented=!1,this.numGroups--,a.cleanup()},step:function(){this.integrate();for(var a=0;a<this.constraintCycles;a++)this.satisfyConstraints();for(a=0;a<this.constraintCollisionCycles;a++)this.satisfyConstraints(),this.checkCollisions()},paint:function(){this.container.renderer.clear();for(var a=0;a<this.numGroups;a++)this.groups[a].paint()},integrate:function(){for(var a=
0;a<this.numGroups;a++)this.groups[a].integrate(this.timeStep)},satisfyConstraints:function(){for(var a=0;a<this.numGroups;a++)this.groups[a].satisfyConstraints()},checkCollisions:function(){for(var a=0;a<this.numGroups;a++)this.groups[a].checkCollisions()}}});
JPE.declare("Sprite",{constructor:function(a){this.renderer=a;this._x=this._y=0;this._children=[];this._visible=!0},addChild:function(a){var b=this._children.indexOf(a);a._parent=this;a.renderer=this.renderer;b==-1&&this._children.push(a)},removeChild:function(a){var b=this._children.indexOf(a);if(b!=-1)this._children.splice(b,1),a._parent=null,a.renderer=null},setX:function(a){this._x=a},getX:function(){return this._x},getGlobalX:function(){return(this._parent?this._parent.getX():0)+this._x},setY:function(a){this._y=
a},getY:function(){return this._y},getGlobalY:function(){return(this._parent?this._parent.getY():0)+this._y},setRotation:function(a){this._rotation=a},getRotation:function(){return this._rotation},getChildren:function(){return this._children},lineStyle:function(a,b,c){this.renderer&&this.renderer.lineStyle(a,b,c)},beginFill:function(a,b){this.renderer&&this.renderer.beginFill(a,b)},drawRect:function(a,b,c,d){this.renderer&&this.renderer.drawRect(a+this.getGlobalX(),b+this.getGlobalY(),c,d)},drawCircle:function(a,
b,c){this.renderer&&this.renderer.drawCircle(a+this.getGlobalX(),b+this.getGlobalY(),c)},endFill:function(){this.renderer&&this.renderer.endFill()}});
(function(){var a=function(a,c){this.x=a||0;this.y=c||0};JPE.mix(a.prototype,{setTo:function(a,c){this.x=a||0;this.y=c||0},copy:function(a){this.x=a.x;this.y=a.y},dot:function(a){return this.x*a.x+this.y*a.y},cross:function(a){return this.x*a.y+this.y*a.x},plus:function(b){return new a(this.x+b.x,this.y+b.y)},plusEquals:function(a){this.x+=a.x;this.y+=a.y;return this},minus:function(b){return new a(this.x-b.x,this.y-b.y)},minusEquals:function(a){this.x-=a.x;this.y-=a.y;return this},mult:function(b){return new a(this.x*
b,this.y*b)},multEquals:function(a){this.x*=a;this.y*=a;return this},times:function(b){return new a(this.x*b.x,this.y*b.y)},divEquals:function(a){a==0&&(a=1.0E-4);this.x/=a;this.y/=a;return this},magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},distance:function(a){return this.minus(a).magnitude()},normalize:function(){var a=this.magnitude();a==0&&(a=1.0E-4);return this.mult(1/a)},toString:function(){return this.x+" : "+this.y}});JPE.Vector=a})();
JPE.declare("CanvasRenderer",function(){return{constructor:function(a){this.canvas=a;this.context=a.getContext("2d")},clear:function(){this.canvas.width=this.canvas.width},lineStyle:function(a,b){this.context.strokeStyle=b;this.context.lineWidth=a||0},beginFill:function(a){this.context.fillStyle=a;this.context.beginPath()},drawRect:function(a,b,c,d){this.context.fillRect(a,b,c,d)},drawCircle:function(a,b,c){this.context.arc(a,b,c,0,Math.PI*2,!0)},endFill:function(){this.context.fill();this.context.stroke();
this.context.closePath()}}});JPE.declare("Interval",{constructor:function(a,b){this.min=a;this.max=b}});JPE.declare("Collision",{constructor:function(a,b){this.vn=a;this.vt=b}});JPE.MathUtil={ONE_EIGHTY_OVER_PI:180/Math.PI,PI_OVER_ONE_EIGHTY:Math.PI/180,clamp:function(a,b,c){if(a<b)return b;if(a>c)return c;return a},sign:function(a){if(a<0)return-1;return 1}};
JPE.declare("AbstractItem",{constructor:function(){this._alwaysRepaint=this._visible=!0;this.lineTickness=0;this.lineColor="#000";this.lineAlpha=1;this.fillColor="#000";this.fillAlpha=1},initSelf:function(){},paint:function(){},cleanup:function(){},getVisible:function(){return this._visible},setVisible:function(a){this._visible=a},getAlwaysRepaint:function(){return this._alwaysRepaint},setAlwaysRepaint:function(a){this._alwaysRepaint=a},setStyle:function(a,b,c,d,e){d=d||"#000";e=e||1;this.setLine(a||
0,b||"#000",c||1);this.setFill(d,e)},setLine:function(a,b,c){this.lineThickness=a;this.lineColor=b;this.lineAlpha=c},setFill:function(a,b){this.fillColor=a;this.fillAlpha=b},getSprite:function(){if(this._sprite!=null)return this._sprite;this._sprite=new JPE.Sprite;JPE.Engine.container.addChild(this._sprite);return this._sprite}});
JPE.CollisionResolver={resolveParticleParticle:function(a,b,c,d){a.curr.copy(a.samp);b.curr.copy(b.samp);var e=c.mult(d),f=a.getElasticity()+b.getElasticity(),g=a.getInvMass()+b.getInvMass(),h=this.clamp(1-(a.getFriction()+b.getFriction()),0,1),i=a.getComponents(c),k=b.getComponents(c),j=k.vn.mult((f+1)*a.getInvMass()).plus(i.vn.mult(b.getInvMass()-f*a.getInvMass())).divEquals(g);f=i.vn.mult((f+1)*b.getInvMass()).plus(k.vn.mult(a.getInvMass()-f*b.getInvMass())).divEquals(g);i.vt.multEquals(h);k.vt.multEquals(h);
h=e.mult(a.getInvMass()/g);e=e.mult(-b.getInvMass()/g);j.plusEquals(i.vt);f.plusEquals(k.vt);a.getFixed()||a.resolveCollision(h,j,c,d,-1,b);b.getFixed()||b.resolveCollision(e,f,c,d,1,a)},clamp:function(a,b,c){if(a>c)return c;if(a<b)return b;return a}};
JPE.declare("CollisionDetector",function(){var a=Number.NEGATIVE_INFINITY;JPE.CollisionDetector={test:function(a,c){if(!a.getFixed()||!c.getFixed())a.getMultisample()==0&&c.getMultisample()==0?this.normVsNorm(a,c):a.getMultisample()>0&&c.getMultisample()==0?this.sampVsNorm(a,c):c.getMultisample()>0&&a.getMultisample()==0?this.sampVsNorm(c,a):a.getMultisample()==c.getMultisample()?this.sampVsSamp(a,c):this.normVsNorm(a,c)},normVsNorm:function(a,c){a.samp.copy(a.curr);c.samp.copy(c.curr);this.testTypes(a,
c)},sampVsNorm:function(a,c){var d=1/(a.getMultisample()+1),e=d,f,g=a.getMultisample();c.samp.copy(c.curr);for(f=0;f<=g;f++){a.samp.setTo(a.prev.x+e*(a.curr.x-a.prev.x),a.prev.y+e*(a.curr.y-a.prev.y));if(this.testTypes(a,c))break;e+=d}},sampVsSamp:function(a,c){var d=1/(a.getMultisample()+1),e=d,f,g=a.getMultisample();for(f=0;f<=g;f++){a.samp.setTo(a.prev.x+e*(a.curr.x-a.prev.x),a.prev.y+e*(a.curr.y-a.prev.y));c.samp.setTo(c.prev.x+e*(c.curr.x-c.prev.x),c.prev.y+e*(a.curr.y-c.prev.y));if(this.testTypes(a,
c))break;e+=d}},testTypes:function(a,c){var d=JPE.RectangleParticle,e=JPE.CircleParticle;if(a instanceof d&&c instanceof d)return this.testOBBvsOBB(a,c);else if(a instanceof e&&c instanceof e)return this.testCirclevsCircle(a,c);else if(a instanceof d&&c instanceof e)return this.testOBBvsCircle(a,c);else if(a instanceof e&&c instanceof d)return this.testOBBvsCircle(a,c);return!1},testOBBvsOBB:function(b,c){for(var d,e=a;;){var f=b.getAxes()[0],g=this.testIntervals(b.getProjection(f),c.getProjection(f));
b.getProjection(f);b.getProjection(f);if(g==0)return!1;var h=c.getAxes()[0],i=this.testIntervals(b.getProjection(h),c.getProjection(h));if(i==0)return!1;var k=Math.abs(g),j=Math.abs(i);if(k<Math.abs(e)||j<Math.abs(e))d=(e=k<j)?f:h,e=e?g:i;JPE.CollisionResolver.resolveParticleParticle(b,c,d,e);return!0}},testOBBvsCircle:function(b,c){for(var d,e=a,f=Array(2),g=0,h,i;g<2;g++){h=b.getAxes()[g];i=this.testIntervals(b.getProjection(h),c.getProjection(h));if(i==0)return!1;Math.abs(i)<Math.abs(e)&&(d=h,
e=i);f[g]=i}g=c.getRadius();if(Math.abs(f[0])<g&&Math.abs(f[1])<g)if(this.closestVertexOnOBB(c.samp,b),d=vertext.minus(c.samp),f=d.magnitude(),e=g-f,e>0)d.divEquals(f);else return!1;JPE.CollisionResolver.resolveParticleParticle(b,c,d,e);return!0},testCirclevsCircle:function(a,c){if(this.testIntervals(a.getIntervalX(),c.getIntervalX())==0)return!1;if(this.testIntervals(a.getIntervalY(),c.getIntervalY())==0)return!1;var d=a.samp.minus(c.samp),e=d.magnitude(),f=a.getRadius()+c.getRadius()-e;if(f>0)return d.divEquals(e),
JPE.CollisionResolver.resolveParticleParticle(a,c,d,f),!0;return!1},testIntervals:function(a,c){if(a.max<c.min)return 0;if(c.max<a.min)return 0;var d=c.max-a.min,e=c.min-a.max;return Math.abs(d)<Math.abs(e)?d:e},closestVertexOnOBB:function(a,c){for(var d=a.minus(c.samp),e=new Vector(c.samp.x,c.samp.y),f=0;f<2;f++){var g=d.dot(c.getAxes()[f]);g>=0?g=c.getExtents()[f]:g<0&&(g=-c.getExtents()[f]);e.plusEquals(c.getAxes()[f].mult(g))}return e}}});
JPE.declare("AbstractCollection",{isParented:!1,particles:[],constraints:[],initSelf:function(){var a=this.particles,b=this.constraints,c=a.length,d=b.length,e;for(e=0;e<c;e++)a[e].initSelf();for(e=0;e<d;e++)b[e].initSelf()},addParticle:function(a){this.particles.push(a);this.isParented&&a.initSelf()},removeParticle:function(a){var b=this.particles.indexOf(a);b!=-1&&(this.particles.splice(b,1),a.cleanup())},addConstraint:function(a){this.constraints.push(a);a.isParented=!0;this.isParented&&a.initSelf()},
removeConstraint:function(a){var b=this.constraints.indexOf(a);b!==-1&&(this.constraints.splice(b,1),a.cleanup())},paint:function(){var a=this.particles,b=this.constraints,c=a.length,d=b.length,e,f;for(f=0;f<c;f++)e=a[f],(!e.getFixed()||e.getAlwaysRepaint())&&e.paint();for(f=0;f<d;f++)a=b[f],(!a.getFixed()||a.getAlwaysRepaint())&&a.paint()},getAll:function(){return this.particles.concat(this.constraints)},cleanup:function(){var a=this.particles,b=this.constraints,c=a.length,d=b.length,e;for(e=0;e<
c;e++)a[e].cleanup();for(e=0;e<d;e++)b[e].cleanup()},integrate:function(a){for(var b=this.particles,c=b.length,d=0;d<c;d++)b[d].update(a)},satisfyConstraints:function(){for(var a=this.constraints,b=a.length,c=0;c<b;c++)a[c].resolve()},checkInternalCollisions:function(){var a=JPE.CollisionDetector,b=this.particles,c=this.constraints,d=b.length,e=c.length,f,g,h,i;for(h=0;h<d;h++)if(f=b[h],f.getCollidable()){for(i=h+1;i<d;i++)g=b[i],g.getCollidable()&&a.test(f,g);for(i=0;i<e;i++)g=c[i],g.getCollidable()&&
g.isConnectedTo(f)&&(g.scp.updatePosition(),a.test(f,g.scp))}},checkCollisionsVsCollection:function(a){var b=JPE.CollisionDetector,c=this.particles,d=a.particles;a=a.constraints;var e=c.length,f=d.length,g=a.length,h,i,k,j;for(k=0;k<e;k++)if(h=c[k],h.collidable){for(j=0;j<f;j++)i=d[j],i.getCollidable()&&b.test(h,i);for(j=0;j<g;j++)i=a[j],i.getCollidable()&&i.isConnectedTo(h)&&(i.scp.updatePosition(),b.test(h,i.scp))}}});
JPE.declare("AbstractParticle",{superclass:JPE.AbstractItem,constructor:function(a,b,c,d,e,f){JPE.AbstractParticle.superclass.prototype.constructor.apply(this,null);this.interval=new JPE.Interval(0,0);var g=JPE.Vector;this.curr=new g(a,b);this.prev=new g(a,b);this.samp=new g;this.temp=new g;this.forces=new g;this.collision=new JPE.Collision(new g,new g);this._fixed=c;this._collidable=!0;this.setMass(d);this._elasticity=e;this._friction=f;this.setStyle();this._center=new g;this._multisample=0},getElasticity:function(){return this._elasticity},
setElasticity:function(a){return this._elasticity=a},getMultisample:function(){return this._multisample},setMultisample:function(a){return this._multisample=a},getCollidable:function(){return this._collidable},setCollidable:function(a){this._collidable=a},getFixed:function(){return this._fixed},setFixed:function(a){this._fixed=a},getMass:function(){return this._mass},setMass:function(a){if(a<=0)throw Error("mass may not be set <= 0");this._mass=a;this._invMass=1/this._mass},getCenter:function(){this._center.setTo(this.getPx(),
this.getPy());return this._center},getFriction:function(){return this._friction},setFriction:function(a){if(a<0||a>1)throw Error("Legal friction must be >= 0 and <=1");this._friction=a},getPosition:function(){return new JPE.Vector(this.curr.x,this.curr.y)},setPosition:function(a){this.curr.copy(a);this.prev.copy(a)},getPx:function(){return this.curr.x},setPx:function(a){this.curr.x=a;this.prev.x=a},getPy:function(){return this.curr.y},setPy:function(a){this.curr.y=a;this.prev.y=a},getVelocity:function(){return this.curr.minus(this.prev)},
setVelocity:function(a){this.prev=this.curr.minus(a)},setDisplay:function(a,b,c,d){this.displayObject=a;this.displayObjectRotation=d||0;this.displayObjectOffset=new JEP.Vector(b,c)},addForce:function(a){this.forces.plusEquals(a.mult(this.getInvMass()))},addMasslessForce:function(a){this.forces.plusEquals(a)},update:function(a){this.getFixed()||(this.addForce(JPE.Engine.force),this.addMasslessForce(JPE.Engine.masslessForce),this.temp.copy(this.curr),this.curr.plusEquals(this.getVelocity().plus(this.forces.multEquals(a)).multEquals(JPE.Engine.damping)),
this.prev.copy(this.temp),this.forces.setTo(0,0))},initDisplay:function(){this.displayObject.setX(displayObjectOffset.x);this.displayObject.setY(displayObjectOffset.y);this.displayObject.setRotation(this.displayObjectRotation);this.getSprite().addChild(this.displayObject)},getComponents:function(a){var b=this.getVelocity(),c=a.dot(b);this.collision.vn=a.mult(c);this.collision.vt=b.minus(this.collision.vn);return this.collision},resolveCollision:function(a,b){this.curr.plusEquals(a);this.setVelocity(b)},
getInvMass:function(){return this.getFixed()?0:this._invMass}});
JPE.declare("Group",{superclass:JPE.AbstractCollection,constructor:function(a){this.composites=[];this.collisionList=[];this.collideInternal=a},initSelf:function(){JPE.Group.superclass.prototype.initSelf.apply(this,arguments);for(var a=0,b=this.composites.length;a<b;a++)this.composites[a].initSelf()},addComposite:function(a){this.composites.push(a);a.isParented=!0;this.isParented&&a.initSelf()},removeComposite:function(a){var b=this.composites.indexOf(a);if(b!==-1)this.composites.splice(b,1),a.isParented=
!1,a.cleanup()},paint:function(){JPE.Group.superclass.prototype.paint.apply(this,arguments);for(var a=this.composites,b=0,c,d=this.composites.length;b<d;b++)c=a[b],c.paint()},addCollidable:function(a){this.collisionList.push(a)},removeCollidable:function(a){a=this.collisionList.indexOf(a);a!=-1&&this.collisionList.splice(a,1)},addCollidableList:function(a){for(var b=0,c=a.length,d=this.collisionList;b<c;b++)d.push(a[b])},getAll:function(){return this.particles.concat(this.constraints).concat(this.composites)},
cleanup:function(){JPE.Group.superclass.prototype.cleanup.apply(this,arguments);for(var a=this.composites,b=a.length,c=0;c<b;c++)a[c].cleanup()},integrate:function(a){JPE.Group.superclass.prototype.integrate.apply(this,arguments);for(var b=this.composites,c=b.length,d=0;d<c;d++)b[d].integrate(a)},satisfyConstraints:function(){JPE.Group.superclass.prototype.satisfyConstraints(this,arguments);for(var a=this.composites,b=a.length,c=0;c<b;c++)a[c].satisfyConstraints()},checkCollisions:function(){this.collideInternal&&
this.checkCollisionGroupInternal();for(var a=this.collisionList,b=a.length,c=0;c<b;c++)this.checkCollisionVsGroup(a[c])},checkCollisionGroupInternal:function(){this.checkInternalCollisions();for(var a=this.composites,b,c,d=a.length,e=0,f;e<d;e++){b=a[e];b.checkCollisionsVsCollection(this);for(f=0;f<d;f++)c=a[f],b.checkCollisionsVsCollection(c)}},checkCollisionVsGroup:function(a){this.checkCollisionsVsCollection(a);for(var b=this.composites,c,d,e=b.length,f=a.composites.length,g=0,h;g<e;g++){c=b[g];
c.checkCollisionsVsCollection(a);for(h=0;h<f;h++)d=a.composites[h],c.checkCollisionsVsCollection(d)}for(h=0;h<f;h++)d=a.composites[h],this.checkCollisionsVsCollection(d)}});
JPE.declare("Composite",{constructor:function(){this.delta=new JPE.Vector},rotateByRadian:function(a,b){for(var c,d=this.particles,e=d.length,f=0;f<e;f++){c=d[f];var g=c.getCenter().distance(b),h=this.getRelativeAngle(b,c.center)+a;c.px=Math.cos(h)*g+b.x;c.py=Math.sin(h)*g+b.y}},rotateByAngle:function(a,b){this.rotateByRadian(a*JPE.MathUtil.PI_OVER_ONE_EIGHTY,b)},getFixed:function(){for(var a=0,b=this.particles.length;a<b;a++)if(!particles[a].getFixed())return!1;return!0},setFixed:function(a){for(var b=
0,c=this.particles.length;b<c;b++)this.particles[b].setFixed(a)},getRelativeAngle:function(a,b){this.delta.setTo(b.x-a.x,b.y-a.y);return Math.atan2(delta.y,delta.x)}});
JPE.declare("CircleParticle",{superclass:JPE.AbstractParticle,constructor:function(a,b,c,d,e,f,g){JPE.CircleParticle.superclass.prototype.constructor.call(this,a,b,d,e||1,f||0.3,g||0);this._radius=c},getRadius:function(){return this._radius},setRadius:function(a){this._radius=a},initSelf:function(){this.cleanup();this.paint()},paint:function(){var a=this.getSprite();a.setX(this.curr.x);a.setY(this.curr.y);a.lineStyle(this.lineThickness,this.lineColor,this.lineAlpha);a.beginFill(this.fillColor,this.fillAlpha);
a.drawCircle(0,0,this.getRadius());a.endFill()},getProjection:function(a){a=this.samp.dot(a);this.interval.min=a-this._radius;this.interval.max=a+this._radius;return this.interval},getIntervalX:function(){this.interval.min=this.curr.x-this._radius;this.interval.max=this.curr.x+this._radius;return this.interval},getIntervalY:function(){this.interval.min=this.curr.y-this._radius;this.interval.max=this.curr.y+this._radius;return this.interval}});
JPE.declare("RectangleParticle",{superclass:JPE.AbstractParticle,constructor:function(a,b,c,d,e,f,g,h,i){e=e||0;JPE.RectangleParticle.superclass.prototype.constructor.call(this,a,b,f,g||1,h||0.3,i||0);this._extents=[c/2,d/2];this._axes=[new JPE.Vector(0,0),new JPE.Vector(0,0)];this.setRadian(e)},getRadian:function(){return this._radian},setRadian:function(a){this._radian=a;this.setAxes(a)},getAngle:function(){return this.getRadian()*JPE.MathUtil.ONE_EIGHTY_OVER_PI},setAngle:function(a){this.setRadian(a*
JPE.MathUtil.PI_OVER_ONE_EIGHTY)},initSelf:function(){this.cleanup();this.paint()},paint:function(){var a=this.getExtents()[0]*2,b=this.getExtents()[1]*2,c=this.getSprite();c.setX(this.curr.x);c.setY(this.curr.y);c.setRotation(this.getAngle());c.lineStyle(this.lineThickness,this.lineColor,this.lineAlpha);c.beginFill(this.fillColor,this.fillAlpha);c.drawRect(-a/2,-b/2,a,b);c.endFill()},setWidth:function(a){this._extents[0]=a/2},getWidth:function(){return this._extents[0]*2},setHeight:function(a){this._extents[1]=
a/2},getHeight:function(){return this._extents[1]*2},getExtents:function(){return this._extents},getProjection:function(a){var b=this.getAxes(),c=this.getExtents();b=c[0]*Math.abs(a.dot(b[0]))+c[1]*Math.abs(a.dot(b[1]));a=this.samp.dot(a);this.interval.min=a-b;this.interval.max=a+b;return this.interval},getAxes:function(){return this._axes},setAxes:function(a){var b=Math.sin(a);a=Math.cos(a);var c=this.getAxes();c[0].x=a;c[0].y=b;c[1].x=-b;c[1].y=a}});
JPE.declare("RimParticle",{constructor:function(a,b){this.av=this.sp=0;this.wr=a;this.maxTorque=b;this.curr=new JPE.Vector(a,0);this.prev=new JPE.Vector(0,0)},getSpeed:function(){return this.sp},setSpeed:function(a){this.sp=a},getAngularVelocity:function(){return this.av},setAngularVelocity:function(a){this.av=a},update:function(){this.sp=Math.max(-this.maxTorque,Math.min(this.maxTorque,this.sp+this.av));var a=-this.curr.y,b=this.curr.x,c=Math.sqrt(a*a+b*b);a/=c;b/=c;this.curr.x+=this.sp*a;this.curr.y+=
this.sp*b;a=this.prev.x;b=this.prev.y;c=this.prev.x=this.curr.x;var d=this.prev.y=this.curr.y;this.curr.x+=JPE.damping*(c-a);this.curr.y+=JPE.damping*(d-b);a=Math.sqrt(this.curr.x*this.curr.x+this.curr.y*this.curr.y);a=(a-this.wr)/a;this.curr.x-=this.curr.x*a;this.curr.y-=this.curr.y*a}});
JPE.declare("WheelParticle",{superclass:JPE.CircleParticle,constructor:function(a,b,c,d,e,f,g,h){h=h||1;JPE.WheelParticle.superclass.prototype.constructor.apply(this,arguments);this.tan=new JPE.Vector(0,0);this.normSlip=new JPE.Vector(0,0);this.rp=new JPE.RimParticle(c,2);this.orientation=new JPE.Vector;this.setTraction(h)},getSpeed:function(){return this.rp.getSpeed()},setSpeed:function(a){this.rp.setSpeed(a)},getAngularVelocity:function(){return this.rp.getAngularVelocity()},setAngularVelocity:function(a){this.rp.setAngularVelocity(a)},
getTraction:function(){return 1-this._traction},setTraction:function(a){this._traction=1-a},paint:function(){var a=this.getSprite();a.setX(this.curr.x);a.setY(this.curr.y);a.lineStyle(this.lineThickness,this.lineColor,this.lineAlpha);a.beginFill(this.fillColor,this.fillAlpha);a.drawCircle(0,0,this.getRadius());a.endFill()},update:function(a){JPE.WheelParticle.superclass.prototype.update.call(this,a);this.rp.update(a)},getRadian:function(){this.orientation.setTo(this.rp.curr.x,this.rp.curr.y);return Math.atan2(this.orientation.y,
this.orientation.x)+Math.PI},getAngle:function(){return this.getRadian()*JPE.MathUtil.ONE_EIGHTY_OVER_PI},resolveCollision:function(a,b,c,d,e){JPE.WheelParticle.superclass.prototype.resolveCollision.apply(this,arguments);this.resolve(c.mult(JPE.MathUtil.sign(d*e)))},resolve:function(a){var b=this.rp,c=this.tan;c.setTo(-b.curr.y,b.curr.x);c=c.normalize();var d=c.mult(b.getSpeed());d=this.getVelocity().plusEquals(d).cross(a);c.multEquals(d);b.prev.copy(b.curr.minus(c));c=(1-this._traction)*b.getSpeed();
this.normSlip.setTo(c*a.y,c*a.x);this.curr.plusEquals(this.normSlip);b.speed*=this._traction}});JPE.declare("AbstractConstraint",{superclass:JPE.AbstractItem,constructor:function(a){this.stiffness=a;this.setStyle()},resolve:function(){}});
JPE.declare("SpringConstraint",{superclass:JPE.AbstractConstraint,constructor:function(a,b,c,d,e,f,g){e=e||1;f=f||1;JPE.SpringConstraint.superclass.prototype.constructor.call(this,c||0.5);this.p1=a;this.p2=b;this.checkParticlesLocation();this._restLength=this.getCurrLength();this.setCollidable(d,e,f,g)},getRadian:function(){var a=this.getDelta();return Math.atan2(a.y,a.x)},getAngle:function(){return this.getRadian()*JPE.MathUtil.ONE_EIGHTY_OVER_PI},getCenter:function(){return this.p1.curr.plus(this.p2.curr).divEquals(2)},
setRectScale:function(a){this.scp!=null&&this.scp.setRectScale(a)},getRectScale:function(){return this.scp.getRectScale()},getCurrLength:function(){return this.p1.curr.distance(this.p2.curr)},getRectHeight:function(){return this.scp.getRectHeight()},setRectHeight:function(a){this.scp!=null&&this.scp.setRectHeight(a)},getRestLength:function(){return this._restLength},setRestLength:function(a){if(a<=0)throw Error("restLength must be greater than 0");this._restLength=a},getFixedEndLimit:function(){return this.scp.getFixedEndLimit()},
setFixedEndLimit:function(a){this.scp!=null&&this.scp.setFixedEndLimit(a)},getCollidable:function(){return this._collidable},setCollidable:function(a){this._collidable=a;this.scp=null;if(this._collidable)this.scp=new JPE.SpringConstraintParticle(this.p1,this.p2,this,this.getRectHeight(),this.getRectScale(),this.getScaleToLength())},isConnectedTo:function(a){return a==this.p1||a==this.p2},getFixed:function(){return this.p1.getFixed()&&this.p2.getFixed()},initSelf:function(){this.cleanup();this.getCollidable()&&
this.scp.initSelf();this.paint()},paint:function(){this.getCollidable()&&this.scp.paint()},getDelta:function(){return this.p1.curr.minus(this.p2.curr)},resolve:function(){var a=this.p1,b=this.p2;if(!a.getFixed()||!b.getFixed()){var c=this.getCurrLength();a=(c-this.getRestLength())/(c*(a.getInvMass()+b.getInvMass()));a=this.getDelta().mult(a*this.stiffness);this.p1.curr.minusEquals(a.mult(this.p1.getInvMass()));this.p2.curr.plusEquals(a.mult(this.p2.getInvMass()))}},checkParticlesLocation:function(){this.p1.curr.x==
this.p2.curr.x&&this.p1.curr.y==this.p2.curr.y&&(this.p2.curr.x+=1.0E-4)}});
JPE.declare("SpringConstraintParticle",{superclass:JPE.RectangleParticle,constructor:function(a,b,c,d,e,f){JPE.RectangleParticle.superclass.constructor.apply(this,0,0,0,0,0,!1);this.p1=a;this.p2=b;this.lambda=new JPE.Vector(0,0);this.avgVelocity=new JPE.Vector(0,0);this.parent=c;this._rectScale=e;this._rectHeight=d;this.scaleToLength=f;this._fixedEndLimit=0;this.rca=new JPE.Vector;this.rcb=new JPE.Vector},setRectScale:function(a){this._rectScale=a},getRectScale:function(){return this._rectScale},
setRectHeight:function(a){this._rectHeight=a},getRectHeight:function(){return this._rectHeight},setFixedEndLimit:function(a){this._fixedEndLimit=a},getFixedEndLimit:function(){return this._fixedEndLimit},getMass:function(){return(this.p1.mass+this.p2.mass)/2},getElasticity:function(){return(this.p1.getElasticity()+this.p2.getElasticity())/2},getFriction:function(){return(this.p1.getFriction()+this.p2.getFriction())/2},getVelocity:function(){var a=this.p1.getVelocity(),b=this.p2.getVelocity();this.avgVelocity.setTo((a.x+
b.x)/2,(a.y+b.y)/2);return this.avgVelocity},initSelf:function(){this.parent.sprite.addChild(this.getSprite());this.paint()},paint:function(){var a=this.parent,b=a.getCenter(),c=this.getSprite();if(this.scaleToLength)c.width=a.getCurrLength()*this.getRectScale();var d=a.getCurrLength()*this.getRectScale(),e=this.getRectHeight();c.x=b.x;c.y=b.y;c.setRotation(a.getAngle());c.lineStyle(a.lineThickness,a.lineColor,a.lineAlpha);c.beginFill(a.fillColor,a.fillAlpha);c.drawRect(-d/2,-e/2,d,e);c.endFill()},
getInvMass:function(){if(this.p1.getFixed()&&this.p2.getFixed())return 0;return 1/((this.p1.getMass()+this.p2.getMass())/2)},updatePosition:function(){},resolveCollision:function(a,b,c,d,e,f){c=this.getContactPointParam(f);d=1-c;e=this.p1;f=this.p2;var g=this.getFixedEndLimit(),h=this.lambda;e.getFixed()?c<=g||(h.setTo(a.x/c,a.y/c),f.curr.plusEquals(h),f.setVelocity(b)):f.getFixed()?d<=g||(h.setTo(a.x/d,a.y/d),e.curr.plusEquals(h),e.setVelocity(b)):(g=d*d+c*c,g!=0&&(h.setTo(a.x/g,a.y/g),e.curr.plusEquals(h.mult(d)),
f.curr.plusEquals(h.mult(c)),c==0.5?(e.setVelocity(b),f.setVelocity(b)):(c<0.5?e:f).setVelocity(b)))},closestParamPoint:function(a){var b=this.p2.curr.minus(this.p1.curr);a=b.dot(a.minus(this.p1.curr))/b.dot(b);return JPE.MathUtil.clamp(a,0,1)},getContactPointParam:function(a){var b;if(a instanceof JPE.CircleParticle)b=this.closestParamPoint(a.curr);else if(a instanceof JPE.RectangleParticle){var c;b=Array(4);for(var d=Number.POSITIVE_INFINITY,e=0;e<4;e++){this.setCorners(a,e);var f=this.closestPtSegmentSegment();
f<d&&(d=f,c=e,b[e]=s)}b=b[c]}return b},setCorners:function(a,b){var c=a.curr.x,d=a.curr.y,e=a.getAxes(),f=a.getExtents(),g=e[0].x*f[0],h=e[0].y*f[0],i=e[1].x*f[1],k=e[1].y*f[1];e=g-i;f=h-k;g+=i;h+=k;i=this.rca;k=this.rcb;if(b==0)i.x=c-g,i.y=d-h,k.x=c+e,k.y=d+f;else if(b==1)i.x=c+e,i.y=d+f,k.x=c+g,k.y=d+h;else if(b==2)i.x=c+g,i.y=d+h,k.x=c-e,k.y=d-f;else if(b==3)i.x=c-e,i.y=d-f,k.x=c-g,k.y=d-h},closestPtSegmentSegment:function(){var a=this.p1.curr,b=this.rca,c=this.rcb,d=this.p2.curr.minus(a);c=c.minus(b);
var e=a.minus(b),f,g=d.dot(d);f=c.dot(c);var h=c.dot(e);e=d.dot(e);var i=d.dot(c),k=g*f-i*i;s=k!=0?JPE.MathUtil.clamp((i*h-e*f)/k,0,1):0.5;f=(i*s+h)/f;f<0?(f=0,s=JPE.MathUtil.clamp(-e/g,0,1)):f>0&&(f=1,s=JPE.MathUtil.clamp((i-e)/g,0,1));a=a.plus(d.mult(s));b=b.plus(c.mult(f));b=a.minus(b);return b.dot(b)}});
